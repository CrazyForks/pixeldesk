<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¢°æ’ç³»ç»Ÿè°ƒè¯•å·¥å…·</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #1a1a1a;
            color: white;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .debug-section {
            background-color: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #444;
        }

        .button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }

        .button:hover {
            background-color: #45a049;
        }

        .button.danger {
            background-color: #f44336;
        }

        .button.danger:hover {
            background-color: #da190b;
        }

        .button.info {
            background-color: #2196F3;
        }

        .button.info:hover {
            background-color: #0b7dda;
        }

        .log {
            background-color: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            height: 300px;
            overflow-y: auto;
            margin: 10px 0;
            white-space: pre-wrap;
        }

        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }

        .status.active {
            background-color: #4CAF50;
            color: white;
        }

        .status.inactive {
            background-color: #666;
            color: #ccc;
        }

        .status.warning {
            background-color: #ff9800;
            color: white;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .info-box {
            background-color: #333;
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
        }

        .info-box h4 {
            margin: 0 0 10px 0;
            color: #4CAF50;
        }

        .info-box p {
            margin: 5px 0;
            font-size: 14px;
        }

        .collision-indicator {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 10px;
        }

        .collision-indicator.active {
            background-color: #f44336;
            animation: pulse 1s infinite;
        }

        .collision-indicator.inactive {
            background-color: #666;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ”§ ç¢°æ’ç³»ç»Ÿè°ƒè¯•å·¥å…·</h1>

        <div class="debug-section">
            <h2>ğŸ® æ¸¸æˆçŠ¶æ€æ£€æŸ¥</h2>
            <div class="grid">
                <div>
                    <div id="gameStatus" class="status inactive">
                        æ¸¸æˆæœªè¿æ¥
                    </div>
                    <button class="button" onclick="checkGameConnection()">æ£€æŸ¥æ¸¸æˆè¿æ¥</button>
                    <button class="button info" onclick="getGameInfo()">è·å–æ¸¸æˆä¿¡æ¯</button>
                </div>
                <div>
                    <div id="playerStatus" class="status inactive">
                        ç©å®¶æœªæ£€æµ‹åˆ°
                    </div>
                    <button class="button" onclick="checkPlayerStatus()">æ£€æŸ¥ç©å®¶çŠ¶æ€</button>
                    <button class="button info" onclick="getPlayerPosition()">è·å–ç©å®¶ä½ç½®</button>
                </div>
            </div>
        </div>

        <div class="debug-section">
            <h2>ğŸ‘¥ æµ‹è¯•ç©å®¶ç®¡ç†</h2>
            <div class="grid">
                <div>
                    <div id="testPlayersStatus" class="status inactive">
                        æµ‹è¯•ç©å®¶æœªåˆ›å»º
                    </div>
                    <button class="button" onclick="createTestPlayers()">åˆ›å»ºæµ‹è¯•ç©å®¶</button>
                    <button class="button info" onclick="listTestPlayers()">åˆ—å‡ºæµ‹è¯•ç©å®¶</button>
                    <button class="button danger" onclick="removeTestPlayers()">ç§»é™¤æµ‹è¯•ç©å®¶</button>
                </div>
                <div>
                    <div id="workstationStatus" class="status inactive">
                        å·¥ä½ä¿¡æ¯æœªè·å–
                    </div>
                    <button class="button" onclick="checkWorkstations()">æ£€æŸ¥å·¥ä½</button>
                    <button class="button info" onclick="getWorkstationStats()">å·¥ä½ç»Ÿè®¡</button>
                </div>
            </div>
        </div>

        <div class="debug-section">
            <h2>ğŸ¯ ç¢°æ’æ£€æµ‹è°ƒè¯•</h2>
            <div class="grid">
                <div>
                    <div id="collisionSystemStatus" class="status inactive">
                        ç¢°æ’ç³»ç»Ÿæœªåˆå§‹åŒ–
                    </div>
                    <button class="button" onclick="initCollisionSystem()">åˆå§‹åŒ–ç¢°æ’ç³»ç»Ÿ</button>
                    <button class="button info" onclick="testCollisionDetection()">æµ‹è¯•ç¢°æ’æ£€æµ‹</button>
                    <button class="button" onclick="adjustCollisionSensitivity()">è°ƒæ•´æ•æ„Ÿåº¦</button>
                </div>
                <div>
                    <div id="collisionStatus" class="status inactive">
                        <span class="collision-indicator inactive"></span>
                        æ— ç¢°æ’æ£€æµ‹
                    </div>
                    <button class="button" onclick="startCollisionMonitoring()">å¼€å§‹ç›‘æ§</button>
                    <button class="button danger" onclick="stopCollisionMonitoring()">åœæ­¢ç›‘æ§</button>
                </div>
            </div>
        </div>

        <div class="debug-section">
            <h2>ğŸ“Š å®æ—¶ä¿¡æ¯</h2>
            <div class="grid">
                <div class="info-box">
                    <h4>ç©å®¶ä¿¡æ¯</h4>
                    <p>ä½ç½®: <span id="playerPosition">æœªçŸ¥</span></p>
                    <p>ç§»åŠ¨çŠ¶æ€: <span id="playerMovement">æœªçŸ¥</span></p>
                    <p>ç¢°æ’è¾¹ç•Œ: <span id="playerBounds">æœªçŸ¥</span></p>
                </div>
                <div class="info-box">
                    <h4>ç¢°æ’ä¿¡æ¯</h4>
                    <p>æ•æ„Ÿåº¦: <span id="collisionSensitivity">50px</span></p>
                    <p>å½“å‰ç¢°æ’: <span id="currentCollisions">0</span></p>
                    <p>å†å²ç¢°æ’: <span id="collisionHistory">0</span></p>
                </div>
            </div>
            <div class="grid">
                <div class="info-box">
                    <h4>æµ‹è¯•ç©å®¶</h4>
                    <p>æ€»æ•°: <span id="testPlayerCount">0</span></p>
                    <p>å¯è§: <span id="visibleTestPlayers">0</span></p>
                    <p>è·ç¦»æœ€è¿‘: <span id="nearestPlayer">æ— </span></p>
                </div>
                <div class="info-box">
                    <h4>äº‹ä»¶æ€»çº¿</h4>
                    <p>çŠ¶æ€: <span id="eventBusStatus">æœªè¿æ¥</span></p>
                    <p>ç›‘å¬å™¨: <span id="eventListeners">0</span></p>
                    <p>äº‹ä»¶è®¡æ•°: <span id="eventCount">0</span></p>
                </div>
            </div>
        </div>

        <div class="debug-section">
            <h2>ğŸ“ è°ƒè¯•æ—¥å¿—</h2>
            <div id="debugLog" class="log">
                ç­‰å¾…è°ƒè¯•ä¿¡æ¯...
            </div>
            <button class="button danger" onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
            <button class="button info" onclick="exportLog()">å¯¼å‡ºæ—¥å¿—</button>
        </div>
    </div>

    <script>
        let monitoringInterval = null
        let eventCount = 0

        // æ—¥å¿—å‡½æ•°
        function log (message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString()
            const logElement = document.getElementById('debugLog')
            const prefix = type === 'error' ? 'âŒ' : type === 'warning' ? 'âš ï¸' : type === 'success' ? 'âœ…' : 'â„¹ï¸'
            const logMessage = `[${timestamp}] ${prefix} ${message}\n`

            logElement.textContent += logMessage
            logElement.scrollTop = logElement.scrollHeight
            console.log(logMessage)
        }

        // æ£€æŸ¥æ¸¸æˆè¿æ¥
        function checkGameConnection () {
            log('æ£€æŸ¥æ¸¸æˆè¿æ¥çŠ¶æ€...')

            if (typeof window !== 'undefined') {
                const hasPhaser = typeof Phaser !== 'undefined'
                const hasGameScene = typeof window.saveGameScene === 'function'
                const hasCollisionFunctions = typeof window.getCurrentCollisions === 'function'

                if (hasPhaser && hasGameScene && hasCollisionFunctions) {
                    document.getElementById('gameStatus').className = 'status active'
                    document.getElementById('gameStatus').textContent = 'æ¸¸æˆå·²è¿æ¥'
                    log('æ¸¸æˆè¿æ¥æ­£å¸¸', 'success')
                } else {
                    document.getElementById('gameStatus').className = 'status warning'
                    document.getElementById('gameStatus').textContent = 'æ¸¸æˆéƒ¨åˆ†è¿æ¥'
                    log(`æ¸¸æˆè¿æ¥çŠ¶æ€: Phaser=${hasPhaser}, GameScene=${hasGameScene}, CollisionFunctions=${hasCollisionFunctions}`, 'warning')
                }
            } else {
                document.getElementById('gameStatus').className = 'status inactive'
                document.getElementById('gameStatus').textContent = 'æ¸¸æˆæœªè¿æ¥'
                log('æ¸¸æˆæœªè¿æ¥', 'error')
            }
        }

        // è·å–æ¸¸æˆä¿¡æ¯
        function getGameInfo () {
            log('è·å–æ¸¸æˆä¿¡æ¯...')

            if (window.getGameWorkstationStats) {
                const stats = window.getGameWorkstationStats()
                log(`å·¥ä½ç»Ÿè®¡: ${JSON.stringify(stats)}`, 'info')
            }

            if (window.getCurrentCollisions) {
                const collisions = window.getCurrentCollisions()
                log(`å½“å‰ç¢°æ’: ${collisions.length} ä¸ª`, 'info')
                document.getElementById('currentCollisions').textContent = collisions.length
            }

            if (window.getCollisionHistory) {
                const history = window.getCollisionHistory()
                log(`ç¢°æ’å†å²: ${history.length} æ¡è®°å½•`, 'info')
                document.getElementById('collisionHistory').textContent = history.length
            }
        }

        // æ£€æŸ¥ç©å®¶çŠ¶æ€
        function checkPlayerStatus () {
            log('æ£€æŸ¥ç©å®¶çŠ¶æ€...')

            // è¿™é‡Œéœ€è¦é€šè¿‡æ¸¸æˆAPIè·å–ç©å®¶ä¿¡æ¯
            // ç”±äºæ— æ³•ç›´æ¥è®¿é—®Phaseråœºæ™¯ï¼Œæˆ‘ä»¬éœ€è¦é€šè¿‡å…¨å±€å‡½æ•°
            if (window.saveGameScene) {
                document.getElementById('playerStatus').className = 'status active'
                document.getElementById('playerStatus').textContent = 'ç©å®¶å·²æ£€æµ‹åˆ°'
                log('ç©å®¶çŠ¶æ€æ­£å¸¸', 'success')
            } else {
                document.getElementById('playerStatus').className = 'status inactive'
                document.getElementById('playerStatus').textContent = 'ç©å®¶æœªæ£€æµ‹åˆ°'
                log('æ— æ³•æ£€æµ‹åˆ°ç©å®¶', 'error')
            }
        }

        // è·å–ç©å®¶ä½ç½®
        function getPlayerPosition () {
            log('è·å–ç©å®¶ä½ç½®...')

            // è¿™é‡Œéœ€è¦æ·»åŠ è·å–ç©å®¶ä½ç½®çš„API
            document.getElementById('playerPosition').textContent = 'éœ€è¦APIæ”¯æŒ'
            log('éœ€è¦æ·»åŠ è·å–ç©å®¶ä½ç½®çš„API', 'warning')
        }

        // åˆ›å»ºæµ‹è¯•ç©å®¶
        function createTestPlayers () {
            log('åˆ›å»ºæµ‹è¯•ç©å®¶...')

            // è¿™é‡Œéœ€è¦è°ƒç”¨æ¸¸æˆä¸­çš„åˆ›å»ºæµ‹è¯•ç©å®¶å‡½æ•°
            if (window.createTestPlayers) {
                window.createTestPlayers()
                log('æµ‹è¯•ç©å®¶åˆ›å»ºå®Œæˆ', 'success')
                document.getElementById('testPlayersStatus').className = 'status active'
                document.getElementById('testPlayersStatus').textContent = 'æµ‹è¯•ç©å®¶å·²åˆ›å»º'
            } else {
                log('æ— æ³•æ‰¾åˆ°åˆ›å»ºæµ‹è¯•ç©å®¶çš„å‡½æ•°', 'error')
            }
        }

        // åˆ—å‡ºæµ‹è¯•ç©å®¶
        function listTestPlayers () {
            log('åˆ—å‡ºæµ‹è¯•ç©å®¶...')

            // è¿™é‡Œéœ€è¦æ·»åŠ åˆ—å‡ºæµ‹è¯•ç©å®¶çš„API
            log('éœ€è¦æ·»åŠ åˆ—å‡ºæµ‹è¯•ç©å®¶çš„API', 'warning')
        }

        // ç§»é™¤æµ‹è¯•ç©å®¶
        function removeTestPlayers () {
            log('ç§»é™¤æµ‹è¯•ç©å®¶...')

            // è¿™é‡Œéœ€è¦æ·»åŠ ç§»é™¤æµ‹è¯•ç©å®¶çš„API
            log('éœ€è¦æ·»åŠ ç§»é™¤æµ‹è¯•ç©å®¶çš„API', 'warning')
        }

        // æ£€æŸ¥å·¥ä½
        function checkWorkstations () {
            log('æ£€æŸ¥å·¥ä½çŠ¶æ€...')

            if (window.getGameWorkstationCount) {
                const count = window.getGameWorkstationCount()
                log(`å·¥ä½æ€»æ•°: ${count}`, 'info')
                document.getElementById('workstationStatus').className = 'status active'
                document.getElementById('workstationStatus').textContent = `å·¥ä½æ€»æ•°: ${count}`
            } else {
                log('æ— æ³•è·å–å·¥ä½ä¿¡æ¯', 'error')
            }
        }

        // è·å–å·¥ä½ç»Ÿè®¡
        function getWorkstationStats () {
            log('è·å–å·¥ä½ç»Ÿè®¡...')

            if (window.getGameWorkstationStats) {
                const stats = window.getGameWorkstationStats()
                log(`å·¥ä½ç»Ÿè®¡: æ€»æ•°=${stats.totalWorkstations}, å·²ç»‘å®š=${stats.boundWorkstations}, å¯ç”¨=${stats.availableWorkstations}`, 'info')
            } else {
                log('æ— æ³•è·å–å·¥ä½ç»Ÿè®¡', 'error')
            }
        }

        // åˆå§‹åŒ–ç¢°æ’ç³»ç»Ÿ
        function initCollisionSystem () {
            log('åˆå§‹åŒ–ç¢°æ’ç³»ç»Ÿ...')

            document.getElementById('collisionSystemStatus').className = 'status active'
            document.getElementById('collisionSystemStatus').textContent = 'ç¢°æ’ç³»ç»Ÿå·²åˆå§‹åŒ–'
            log('ç¢°æ’ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ', 'success')
        }

        // æµ‹è¯•ç¢°æ’æ£€æµ‹
        function testCollisionDetection () {
            log('æµ‹è¯•ç¢°æ’æ£€æµ‹...')

            if (window.testCollisionSystem) {
                const result = window.testCollisionSystem()
                if (result.success) {
                    log(`ç¢°æ’æµ‹è¯•: ${result.message}`, 'success')
                } else {
                    log(`ç¢°æ’æµ‹è¯•å¤±è´¥: ${result.message}`, 'error')
                }
            } else {
                log('æ— æ³•æ‰¾åˆ°ç¢°æ’æµ‹è¯•å‡½æ•°', 'error')
            }
        }

        // è°ƒæ•´ç¢°æ’æ•æ„Ÿåº¦
        function adjustCollisionSensitivity () {
            const newSensitivity = prompt('è¾“å…¥æ–°çš„ç¢°æ’æ•æ„Ÿåº¦ (10-200):', '50')
            if (newSensitivity && !isNaN(newSensitivity)) {
                const sensitivity = parseInt(newSensitivity)
                if (window.setCollisionSensitivity) {
                    window.setCollisionSensitivity(sensitivity)
                    document.getElementById('collisionSensitivity').textContent = sensitivity + 'px'
                    log(`ç¢°æ’æ•æ„Ÿåº¦è®¾ç½®ä¸º: ${sensitivity}px`, 'success')
                } else {
                    log('æ— æ³•è®¾ç½®ç¢°æ’æ•æ„Ÿåº¦', 'error')
                }
            }
        }

        // å¼€å§‹ç¢°æ’ç›‘æ§
        function startCollisionMonitoring () {
            log('å¼€å§‹ç¢°æ’ç›‘æ§...')

            if (monitoringInterval) {
                clearInterval(monitoringInterval)
            }

            monitoringInterval = setInterval(() => {
                updateCollisionStatus()
                updatePlayerInfo()
            }, 500)

            document.getElementById('collisionStatus').className = 'status active'
            document.getElementById('collisionStatus').innerHTML = '<span class="collision-indicator active"></span>ç¢°æ’ç›‘æ§ä¸­'
            log('ç¢°æ’ç›‘æ§å·²å¯åŠ¨', 'success')
        }

        // åœæ­¢ç¢°æ’ç›‘æ§
        function stopCollisionMonitoring () {
            log('åœæ­¢ç¢°æ’ç›‘æ§...')

            if (monitoringInterval) {
                clearInterval(monitoringInterval)
                monitoringInterval = null
            }

            document.getElementById('collisionStatus').className = 'status inactive'
            document.getElementById('collisionStatus').innerHTML = '<span class="collision-indicator inactive"></span>ç¢°æ’ç›‘æ§å·²åœæ­¢'
            log('ç¢°æ’ç›‘æ§å·²åœæ­¢', 'info')
        }

        // æ›´æ–°ç¢°æ’çŠ¶æ€
        function updateCollisionStatus () {
            if (window.getCurrentCollisions) {
                const collisions = window.getCurrentCollisions()
                document.getElementById('currentCollisions').textContent = collisions.length

                if (collisions.length > 0) {
                    const playerNames = collisions.map(c => c.name).join(', ')
                    document.getElementById('nearestPlayer').textContent = playerNames
                } else {
                    document.getElementById('nearestPlayer').textContent = 'æ— '
                }
            }
        }

        // æ›´æ–°ç©å®¶ä¿¡æ¯
        function updatePlayerInfo () {
            // è¿™é‡Œéœ€è¦æ·»åŠ è·å–ç©å®¶å®æ—¶ä¿¡æ¯çš„API
            document.getElementById('playerMovement').textContent = 'éœ€è¦APIæ”¯æŒ'
            document.getElementById('playerBounds').textContent = 'éœ€è¦APIæ”¯æŒ'
        }

        // æ¸…é™¤æ—¥å¿—
        function clearLog () {
            document.getElementById('debugLog').textContent = 'æ—¥å¿—å·²æ¸…é™¤...\n'
        }

        // å¯¼å‡ºæ—¥å¿—
        function exportLog () {
            const logContent = document.getElementById('debugLog').textContent
            const blob = new Blob([logContent], { type: 'text/plain' })
            const url = URL.createObjectURL(blob)
            const a = document.createElement('a')
            a.href = url
            a.download = `collision-debug-${new Date().toISOString().slice(0, 19)}.txt`
            document.body.appendChild(a)
            a.click()
            document.body.removeChild(a)
            URL.revokeObjectURL(url)
            log('æ—¥å¿—å·²å¯¼å‡º', 'success')
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        window.addEventListener('load', function () {
            log('ğŸ”§ ç¢°æ’ç³»ç»Ÿè°ƒè¯•å·¥å…·å·²åŠ è½½')
            checkGameConnection()

            // è®¾ç½®å®šæ—¶æ£€æŸ¥
            setInterval(() => {
                if (window.getCurrentCollisions) {
                    updateCollisionStatus()
                }
            }, 2000)
        })

        // ç›‘å¬äº‹ä»¶æ€»çº¿äº‹ä»¶
        if (typeof window !== 'undefined' && window.gameEventBus) {
            window.gameEventBus.on('player:collision:start', (event) => {
                eventCount++
                log(`ç¢°æ’å¼€å§‹: ${event.targetPlayer.name}`, 'success')
                document.getElementById('eventCount').textContent = eventCount
            })

            window.gameEventBus.on('player:collision:end', (event) => {
                eventCount++
                log(`ç¢°æ’ç»“æŸ: ${event.targetPlayer.name}`, 'info')
                document.getElementById('eventCount').textContent = eventCount
            })

            document.getElementById('eventBusStatus').textContent = 'å·²è¿æ¥'
        } else {
            document.getElementById('eventBusStatus').textContent = 'æœªè¿æ¥'
        }
    </script>
</body>

</html>