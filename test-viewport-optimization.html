<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è§†å£ä¼˜åŒ–åŠŸèƒ½æµ‹è¯•</title>
    <style>
        body { 
            font-family: monospace; 
            background: #1a1a1a; 
            color: #fff; 
            margin: 20px; 
            line-height: 1.6; 
        }
        .container { 
            max-width: 1200px; 
            margin: 0 auto; 
        }
        .section { 
            background: #2a2a2a; 
            padding: 20px; 
            margin: 10px 0; 
            border-radius: 8px; 
            border: 1px solid #444; 
        }
        .stats { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); 
            gap: 15px; 
            margin-top: 15px; 
        }
        .stat-item { 
            background: #3a3a3a; 
            padding: 10px; 
            border-radius: 4px; 
            border-left: 3px solid #0066cc; 
        }
        .highlight { 
            color: #00ff88; 
            font-weight: bold; 
        }
        .warning { 
            color: #ffaa00; 
            font-weight: bold; 
        }
        .error { 
            color: #ff4444; 
            font-weight: bold; 
        }
        button { 
            background: #0066cc; 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            margin: 5px; 
            border-radius: 4px; 
            cursor: pointer; 
        }
        button:hover { 
            background: #0052a3; 
        }
        pre { 
            background: #1a1a1a; 
            padding: 10px; 
            border-radius: 4px; 
            overflow-x: auto; 
            border: 1px solid #444; 
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸš€ è§†å£ä¼˜åŒ–åŠŸèƒ½æµ‹è¯•é¡µé¢</h1>
        
        <div class="section">
            <h2>ğŸ“Š APIæ¥å£æµ‹è¯•</h2>
            <button onclick="testVisibleBindingsAPI()">æµ‹è¯•è§†å£èŒƒå›´æŸ¥è¯¢API</button>
            <button onclick="testHealthCheck()">æµ‹è¯•å¥åº·æ£€æŸ¥</button>
            <div id="api-results"></div>
        </div>
        
        <div class="section">
            <h2>ğŸ® Phaseræ¸¸æˆçŠ¶æ€</h2>
            <button onclick="checkGameStatus()">æ£€æŸ¥æ¸¸æˆçŠ¶æ€</button>
            <button onclick="getViewportStats()">è·å–è§†å£ä¼˜åŒ–ç»Ÿè®¡</button>
            <button onclick="getWorkstationStats()">è·å–å·¥ä½ç»Ÿè®¡</button>
            <div id="game-results"></div>
        </div>
        
        <div class="section">
            <h2>âš¡ å®æ—¶ç›‘æ§</h2>
            <button onclick="startMonitoring()" id="monitor-btn">å¼€å§‹ç›‘æ§</button>
            <button onclick="stopMonitoring()">åœæ­¢ç›‘æ§</button>
            <div id="monitoring-results"></div>
        </div>
        
        <div class="section">
            <h2>ğŸ§ª æ€§èƒ½å¯¹æ¯”æµ‹è¯•</h2>
            <button onclick="performanceTest()">æ‰§è¡Œæ€§èƒ½å¯¹æ¯”</button>
            <div id="performance-results"></div>
        </div>
    </div>

    <script>
        let monitoringInterval = null;
        
        // æ ¼å¼åŒ–JSONæ˜¾ç¤º
        function formatJSON(obj) {
            return JSON.stringify(obj, null, 2);
        }
        
        // æ˜¾ç¤ºç»“æœ
        function showResult(elementId, title, result, isError = false) {
            const element = document.getElementById(elementId);
            const className = isError ? 'error' : 'highlight';
            const time = new Date().toLocaleTimeString();
            element.innerHTML = `
                <h3 class="${className}">${title} [${time}]</h3>
                <pre>${formatJSON(result)}</pre>
            ` + element.innerHTML;
        }
        
        // æµ‹è¯•è§†å£èŒƒå›´æŸ¥è¯¢API
        async function testVisibleBindingsAPI() {
            try {
                const testData = {
                    workstationIds: [1, 2, 3, 4, 5, 10, 15, 20],
                    viewport: {
                        x: 100,
                        y: 100, 
                        width: 800,
                        height: 600,
                        zoom: 1
                    }
                };
                
                const response = await fetch('/api/workstations/visible-bindings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testData)
                });
                
                const result = await response.json();
                showResult('api-results', 'âœ… è§†å£èŒƒå›´æŸ¥è¯¢APIæµ‹è¯•', result);
                
            } catch (error) {
                showResult('api-results', 'âŒ APIæµ‹è¯•å¤±è´¥', { error: error.message }, true);
            }
        }
        
        // æµ‹è¯•å¥åº·æ£€æŸ¥
        async function testHealthCheck() {
            try {
                const response = await fetch('/api/workstations/visible-bindings');
                const result = await response.json();
                showResult('api-results', 'âœ… å¥åº·æ£€æŸ¥', result);
            } catch (error) {
                showResult('api-results', 'âŒ å¥åº·æ£€æŸ¥å¤±è´¥', { error: error.message }, true);
            }
        }
        
        // æ£€æŸ¥æ¸¸æˆçŠ¶æ€
        function checkGameStatus() {
            const gameExists = typeof window.getViewportOptimizationStats === 'function';
            const workstationStatsExists = typeof window.getGameWorkstationStats === 'function';
            
            const status = {
                gameLoaded: gameExists,
                viewportOptimizationAvailable: gameExists,
                workstationStatsAvailable: workstationStatsExists,
                phaserGameElement: document.getElementById('phaser-game') !== null
            };
            
            showResult('game-results', gameExists ? 'âœ… æ¸¸æˆçŠ¶æ€æ£€æŸ¥' : 'âš ï¸ æ¸¸æˆçŠ¶æ€æ£€æŸ¥', status, !gameExists);
        }
        
        // è·å–è§†å£ä¼˜åŒ–ç»Ÿè®¡
        function getViewportStats() {
            if (typeof window.getViewportOptimizationStats === 'function') {
                const stats = window.getViewportOptimizationStats();
                showResult('game-results', 'ğŸ“Š è§†å£ä¼˜åŒ–ç»Ÿè®¡', stats);
            } else {
                showResult('game-results', 'âŒ è§†å£ä¼˜åŒ–ä¸å¯ç”¨', 
                    { error: 'è¯·å…ˆåŠ è½½æ¸¸æˆé¡µé¢' }, true);
            }
        }
        
        // è·å–å·¥ä½ç»Ÿè®¡
        function getWorkstationStats() {
            if (typeof window.getGameWorkstationStats === 'function') {
                const stats = window.getGameWorkstationStats();
                showResult('game-results', 'ğŸ¢ å·¥ä½ç»Ÿè®¡', stats);
            } else {
                showResult('game-results', 'âŒ å·¥ä½ç»Ÿè®¡ä¸å¯ç”¨', 
                    { error: 'è¯·å…ˆåŠ è½½æ¸¸æˆé¡µé¢' }, true);
            }
        }
        
        // å¼€å§‹å®æ—¶ç›‘æ§
        function startMonitoring() {
            if (monitoringInterval) {
                console.log('ç›‘æ§å·²åœ¨è¿è¡Œ');
                return;
            }
            
            const button = document.getElementById('monitor-btn');
            button.textContent = 'ç›‘æ§ä¸­...';
            button.disabled = true;
            
            monitoringInterval = setInterval(() => {
                const timestamp = new Date().toLocaleTimeString();
                let monitorData = { timestamp };
                
                // è·å–è§†å£ä¼˜åŒ–ç»Ÿè®¡
                if (typeof window.getViewportOptimizationStats === 'function') {
                    monitorData.viewport = window.getViewportOptimizationStats();
                }
                
                // è·å–å·¥ä½ç»Ÿè®¡  
                if (typeof window.getGameWorkstationStats === 'function') {
                    monitorData.workstations = window.getGameWorkstationStats();
                }
                
                const element = document.getElementById('monitoring-results');
                const isOptimized = monitorData.viewport?.enabled || false;
                const className = isOptimized ? 'highlight' : 'warning';
                
                element.innerHTML = `
                    <h4 class="${className}">ğŸ“Š å®æ—¶ç›‘æ§æ•°æ®</h4>
                    <pre>${formatJSON(monitorData)}</pre>
                `;
                
            }, 2000); // æ¯2ç§’æ›´æ–°ä¸€æ¬¡
        }
        
        // åœæ­¢ç›‘æ§
        function stopMonitoring() {
            if (monitoringInterval) {
                clearInterval(monitoringInterval);
                monitoringInterval = null;
                
                const button = document.getElementById('monitor-btn');
                button.textContent = 'å¼€å§‹ç›‘æ§';
                button.disabled = false;
            }
        }
        
        // æ€§èƒ½å¯¹æ¯”æµ‹è¯•
        async function performanceTest() {
            try {
                console.log('å¼€å§‹æ€§èƒ½å¯¹æ¯”æµ‹è¯•...');
                
                // æµ‹è¯•ä¸åŒæ•°é‡å·¥ä½çš„æŸ¥è¯¢æ€§èƒ½
                const testSizes = [10, 50, 100, 500, 1000];
                const results = [];
                
                for (const size of testSizes) {
                    const workstationIds = Array.from({length: size}, (_, i) => i + 1);
                    
                    const startTime = performance.now();
                    
                    const response = await fetch('/api/workstations/visible-bindings', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ workstationIds })
                    });
                    
                    const result = await response.json();
                    const endTime = performance.now();
                    const clientTime = endTime - startTime;
                    
                    results.push({
                        requestSize: size,
                        serverTime: result.stats?.queryTime || 0,
                        clientTime: Math.round(clientTime),
                        totalTime: Math.round(clientTime),
                        foundBindings: result.stats?.found || 0,
                        efficiency: result.stats?.efficiency || '0%'
                    });
                    
                    // æ·»åŠ å»¶è¿Ÿé¿å…è¿‡è½½
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                // è®¡ç®—æ€§èƒ½æ”¹è¿›
                const performanceSummary = {
                    testResults: results,
                    averageServerTime: (results.reduce((sum, r) => sum + r.serverTime, 0) / results.length).toFixed(1) + 'ms',
                    averageClientTime: (results.reduce((sum, r) => sum + r.clientTime, 0) / results.length).toFixed(1) + 'ms',
                    maxRequestSize: Math.max(...results.map(r => r.requestSize)),
                    conclusion: results[results.length - 1].totalTime < 1000 ? 
                        'âœ… ä¼˜åŒ–æ•ˆæœè‰¯å¥½ï¼Œå³ä½¿1000ä¸ªå·¥ä½æŸ¥è¯¢ä¹Ÿå¾ˆå¿«' : 
                        'âš ï¸ å¤§è§„æ¨¡æŸ¥è¯¢ä»éœ€è¿›ä¸€æ­¥ä¼˜åŒ–'
                };
                
                showResult('performance-results', 'âš¡ æ€§èƒ½å¯¹æ¯”æµ‹è¯•ç»“æœ', performanceSummary);
                
            } catch (error) {
                showResult('performance-results', 'âŒ æ€§èƒ½æµ‹è¯•å¤±è´¥', { error: error.message }, true);
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥çŠ¶æ€
        window.addEventListener('load', () => {
            setTimeout(() => {
                checkGameStatus();
                testHealthCheck();
            }, 1000);
        });
    </script>
</body>
</html>