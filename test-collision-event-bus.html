<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¢°æ’äº‹ä»¶æ€»çº¿æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #1a1a1a;
            color: white;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
        }
        .test-section {
            background-color: #2a2a2a;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            border: 1px solid #444;
        }
        .button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background-color: #45a049;
        }
        .button.danger {
            background-color: #f44336;
        }
        .button.danger:hover {
            background-color: #da190b;
        }
        .log {
            background-color: #000;
            color: #0f0;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
        .status {
            padding: 10px;
            margin: 10px 0;
            border-radius: 4px;
        }
        .status.active {
            background-color: #4CAF50;
            color: white;
        }
        .status.inactive {
            background-color: #666;
            color: #ccc;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ® ç¢°æ’äº‹ä»¶æ€»çº¿æµ‹è¯•</h1>
        
        <div class="test-section">
            <h2>ğŸ“¡ äº‹ä»¶æ€»çº¿çŠ¶æ€</h2>
            <div id="eventBusStatus" class="status inactive">
                äº‹ä»¶æ€»çº¿æœªåˆå§‹åŒ–
            </div>
            <button class="button" onclick="initializeEventBus()">åˆå§‹åŒ–äº‹ä»¶æ€»çº¿</button>
            <button class="button" onclick="testEventBus()">æµ‹è¯•äº‹ä»¶æ€»çº¿</button>
        </div>

        <div class="test-section">
            <h2>ğŸ¯ ç¢°æ’äº‹ä»¶æµ‹è¯•</h2>
            <div id="collisionStatus" class="status inactive">
                æ— ç¢°æ’äº‹ä»¶
            </div>
            <button class="button" onclick="simulateCollisionStart()">æ¨¡æ‹Ÿç¢°æ’å¼€å§‹</button>
            <button class="button" onclick="simulateCollisionEnd()">æ¨¡æ‹Ÿç¢°æ’ç»“æŸ</button>
            <button class="button danger" onclick="clearCollisionEvents()">æ¸…é™¤ç¢°æ’äº‹ä»¶</button>
        </div>

        <div class="test-section">
            <h2>ğŸ“‹ æ ‡ç­¾é¡µåˆ‡æ¢æµ‹è¯•</h2>
            <div id="tabStatus" class="status inactive">
                å½“å‰æ ‡ç­¾é¡µ: æœªçŸ¥
            </div>
            <button class="button" onclick="simulateTabSwitch('status-info')">åˆ‡æ¢åˆ°çŠ¶æ€ä¿¡æ¯</button>
            <button class="button" onclick="simulateTabSwitch('player-interaction')">åˆ‡æ¢åˆ°ç©å®¶äº¤äº’</button>
        </div>

        <div class="test-section">
            <h2>ğŸ“Š äº‹ä»¶ç»Ÿè®¡</h2>
            <div id="eventStats">
                <p>ç¢°æ’å¼€å§‹äº‹ä»¶: <span id="collisionStartCount">0</span></p>
                <p>ç¢°æ’ç»“æŸäº‹ä»¶: <span id="collisionEndCount">0</span></p>
                <p>æ ‡ç­¾é¡µåˆ‡æ¢äº‹ä»¶: <span id="tabSwitchCount">0</span></p>
                <p>æ€»äº‹ä»¶æ•°: <span id="totalEventCount">0</span></p>
            </div>
            <button class="button danger" onclick="resetStats()">é‡ç½®ç»Ÿè®¡</button>
        </div>

        <div class="test-section">
            <h2>ğŸ“ äº‹ä»¶æ—¥å¿—</h2>
            <div id="eventLog" class="log">
                ç­‰å¾…äº‹ä»¶...
            </div>
            <button class="button danger" onclick="clearLog()">æ¸…é™¤æ—¥å¿—</button>
        </div>
    </div>

    <script>
        // äº‹ä»¶ç»Ÿè®¡
        let stats = {
            collisionStart: 0,
            collisionEnd: 0,
            tabSwitch: 0,
            total: 0
        };

        // æ¨¡æ‹Ÿäº‹ä»¶æ€»çº¿ï¼ˆç®€åŒ–ç‰ˆæœ¬ï¼‰
        class MockEventBus {
            constructor() {
                this.listeners = new Map();
                this.debugMode = true;
            }

            on(event, callback) {
                if (!this.listeners.has(event)) {
                    this.listeners.set(event, new Set());
                }
                this.listeners.get(event).add(callback);
                this.log(`[EventBus] è®¢é˜…äº‹ä»¶: ${event}`);
            }

            off(event, callback) {
                const eventListeners = this.listeners.get(event);
                if (eventListeners) {
                    eventListeners.delete(callback);
                    if (eventListeners.size === 0) {
                        this.listeners.delete(event);
                    }
                    this.log(`[EventBus] å–æ¶ˆè®¢é˜…äº‹ä»¶: ${event}`);
                }
            }

            emit(event, data) {
                const eventListeners = this.listeners.get(event);
                if (eventListeners && eventListeners.size > 0) {
                    this.log(`[EventBus] å‘é€äº‹ä»¶: ${event}`, data);
                    const listenersArray = Array.from(eventListeners);
                    listenersArray.forEach(callback => {
                        try {
                            callback(data);
                        } catch (error) {
                            this.log(`[EventBus] äº‹ä»¶ç›‘å¬å™¨é”™è¯¯ ${event}: ${error.message}`);
                        }
                    });
                } else {
                    this.log(`[EventBus] æ²¡æœ‰ç›‘å¬å™¨: ${event}`);
                }
            }

            log(message, data = null) {
                const timestamp = new Date().toLocaleTimeString();
                const logElement = document.getElementById('eventLog');
                const logMessage = `[${timestamp}] ${message}`;
                
                if (data) {
                    logElement.innerHTML += `${logMessage}\n${JSON.stringify(data, null, 2)}\n\n`;
                } else {
                    logElement.innerHTML += `${logMessage}\n`;
                }
                
                logElement.scrollTop = logElement.scrollHeight;
                console.log(logMessage, data);
            }

            listenerCount(event) {
                return this.listeners.get(event)?.size || 0;
            }

            eventNames() {
                return Array.from(this.listeners.keys());
            }
        }

        let eventBus = null;
        let currentCollisionPlayer = null;
        let currentTab = 'status-info';

        // åˆå§‹åŒ–äº‹ä»¶æ€»çº¿
        function initializeEventBus() {
            eventBus = new MockEventBus();
            
            // è®¾ç½®ç¢°æ’äº‹ä»¶ç›‘å¬å™¨
            eventBus.on('player:collision:start', handleCollisionStart);
            eventBus.on('player:collision:end', handleCollisionEnd);
            eventBus.on('tab:switch', handleTabSwitch);

            // æ›´æ–°çŠ¶æ€æ˜¾ç¤º
            document.getElementById('eventBusStatus').className = 'status active';
            document.getElementById('eventBusStatus').textContent = 'äº‹ä»¶æ€»çº¿å·²åˆå§‹åŒ–';
            
            eventBus.log('ğŸš€ äº‹ä»¶æ€»çº¿åˆå§‹åŒ–å®Œæˆ');
        }

        // æµ‹è¯•äº‹ä»¶æ€»çº¿
        function testEventBus() {
            if (!eventBus) {
                alert('è¯·å…ˆåˆå§‹åŒ–äº‹ä»¶æ€»çº¿');
                return;
            }

            // å‘é€æµ‹è¯•äº‹ä»¶
            eventBus.emit('test:event', { message: 'è¿™æ˜¯ä¸€ä¸ªæµ‹è¯•äº‹ä»¶', timestamp: Date.now() });
            
            // æ˜¾ç¤ºç›‘å¬å™¨ç»Ÿè®¡
            const eventNames = eventBus.eventNames();
            eventBus.log(`ğŸ“Š å½“å‰æ³¨å†Œçš„äº‹ä»¶: ${eventNames.join(', ')}`);
            eventNames.forEach(eventName => {
                const count = eventBus.listenerCount(eventName);
                eventBus.log(`   - ${eventName}: ${count} ä¸ªç›‘å¬å™¨`);
            });
        }

        // å¤„ç†ç¢°æ’å¼€å§‹äº‹ä»¶
        function handleCollisionStart(event) {
            currentCollisionPlayer = event.targetPlayer;
            stats.collisionStart++;
            stats.total++;
            updateStats();
            
            document.getElementById('collisionStatus').className = 'status active';
            document.getElementById('collisionStatus').textContent = `ç¢°æ’ä¸­: ${event.targetPlayer.name}`;
            
            eventBus.log('ğŸ¯ ç¢°æ’å¼€å§‹äº‹ä»¶å¤„ç†å®Œæˆ');
        }

        // å¤„ç†ç¢°æ’ç»“æŸäº‹ä»¶
        function handleCollisionEnd(event) {
            currentCollisionPlayer = null;
            stats.collisionEnd++;
            stats.total++;
            updateStats();
            
            document.getElementById('collisionStatus').className = 'status inactive';
            document.getElementById('collisionStatus').textContent = 'æ— ç¢°æ’äº‹ä»¶';
            
            eventBus.log('ğŸ¯ ç¢°æ’ç»“æŸäº‹ä»¶å¤„ç†å®Œæˆ');
        }

        // å¤„ç†æ ‡ç­¾é¡µåˆ‡æ¢äº‹ä»¶
        function handleTabSwitch(event) {
            currentTab = event.toTab;
            stats.tabSwitch++;
            stats.total++;
            updateStats();
            
            document.getElementById('tabStatus').className = 'status active';
            document.getElementById('tabStatus').textContent = `å½“å‰æ ‡ç­¾é¡µ: ${event.toTab} (${event.trigger})`;
            
            eventBus.log('ğŸ“‹ æ ‡ç­¾é¡µåˆ‡æ¢äº‹ä»¶å¤„ç†å®Œæˆ');
        }

        // æ¨¡æ‹Ÿç¢°æ’å¼€å§‹
        function simulateCollisionStart() {
            if (!eventBus) {
                alert('è¯·å…ˆåˆå§‹åŒ–äº‹ä»¶æ€»çº¿');
                return;
            }

            const collisionEvent = {
                type: 'collision_start',
                mainPlayer: {
                    id: 'main-player',
                    name: 'æˆ‘',
                    currentStatus: {
                        type: 'working',
                        status: 'å·¥ä½œä¸­',
                        emoji: 'ğŸ’¼',
                        message: 'æ­£åœ¨æµ‹è¯•ç¢°æ’ç³»ç»Ÿ',
                        timestamp: new Date().toISOString()
                    }
                },
                targetPlayer: {
                    id: 'test-player-1',
                    name: 'å¼ ä¸‰',
                    currentStatus: {
                        type: 'working',
                        status: 'å·¥ä½œä¸­',
                        emoji: 'ğŸ’¼',
                        message: 'æ­£åœ¨å¼€å‘æ–°åŠŸèƒ½...',
                        timestamp: new Date().toISOString()
                    }
                },
                timestamp: Date.now(),
                position: { x: 100, y: 200 }
            };

            eventBus.emit('player:collision:start', collisionEvent);
        }

        // æ¨¡æ‹Ÿç¢°æ’ç»“æŸ
        function simulateCollisionEnd() {
            if (!eventBus) {
                alert('è¯·å…ˆåˆå§‹åŒ–äº‹ä»¶æ€»çº¿');
                return;
            }

            const collisionEvent = {
                type: 'collision_end',
                mainPlayer: {
                    id: 'main-player',
                    name: 'æˆ‘',
                    currentStatus: {
                        type: 'working',
                        status: 'å·¥ä½œä¸­',
                        emoji: 'ğŸ’¼',
                        message: 'æ­£åœ¨æµ‹è¯•ç¢°æ’ç³»ç»Ÿ',
                        timestamp: new Date().toISOString()
                    }
                },
                targetPlayer: {
                    id: 'test-player-1',
                    name: 'å¼ ä¸‰',
                    currentStatus: {
                        type: 'working',
                        status: 'å·¥ä½œä¸­',
                        emoji: 'ğŸ’¼',
                        message: 'æ­£åœ¨å¼€å‘æ–°åŠŸèƒ½...',
                        timestamp: new Date().toISOString()
                    }
                },
                timestamp: Date.now(),
                duration: 2500,
                position: { x: 150, y: 250 }
            };

            eventBus.emit('player:collision:end', collisionEvent);
        }

        // æ¨¡æ‹Ÿæ ‡ç­¾é¡µåˆ‡æ¢
        function simulateTabSwitch(tabId) {
            if (!eventBus) {
                alert('è¯·å…ˆåˆå§‹åŒ–äº‹ä»¶æ€»çº¿');
                return;
            }

            const tabSwitchEvent = {
                type: 'tab_switch',
                fromTab: currentTab,
                toTab: tabId,
                trigger: 'manual',
                timestamp: Date.now()
            };

            eventBus.emit('tab:switch', tabSwitchEvent);
        }

        // æ¸…é™¤ç¢°æ’äº‹ä»¶
        function clearCollisionEvents() {
            currentCollisionPlayer = null;
            document.getElementById('collisionStatus').className = 'status inactive';
            document.getElementById('collisionStatus').textContent = 'æ— ç¢°æ’äº‹ä»¶';
            
            if (eventBus) {
                eventBus.log('ğŸ§¹ ç¢°æ’äº‹ä»¶å·²æ¸…é™¤');
            }
        }

        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            document.getElementById('collisionStartCount').textContent = stats.collisionStart;
            document.getElementById('collisionEndCount').textContent = stats.collisionEnd;
            document.getElementById('tabSwitchCount').textContent = stats.tabSwitch;
            document.getElementById('totalEventCount').textContent = stats.total;
        }

        // é‡ç½®ç»Ÿè®¡
        function resetStats() {
            stats = {
                collisionStart: 0,
                collisionEnd: 0,
                tabSwitch: 0,
                total: 0
            };
            updateStats();
            
            if (eventBus) {
                eventBus.log('ğŸ“Š ç»Ÿè®¡ä¿¡æ¯å·²é‡ç½®');
            }
        }

        // æ¸…é™¤æ—¥å¿—
        function clearLog() {
            document.getElementById('eventLog').innerHTML = 'æ—¥å¿—å·²æ¸…é™¤...\n';
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        window.addEventListener('load', function() {
            console.log('ğŸ® ç¢°æ’äº‹ä»¶æ€»çº¿æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
            updateStats();
        });
    </script>
</body>
</html>